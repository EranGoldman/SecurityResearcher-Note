# Day 11 - XDR insights - File Analysis <1/1>
Thank you for visiting my XDR blog. This post specifically delves into analyzing malware file information from generated alerts in Microsoft 365 Defender. 
The blog primarily focuses on the foundational aspects of malware analysis, excluding intricate content such as reverse engineering or complex debugging.
While I extensively cover Microsoft 365 Defender, I will also utilize  third-party tools for in-depth analysis.

## What insights can we extract from alerts?
When alerts are generated, Microsoft Defender Antivirus and Microsoft Defender for Endpoint provide a wealth of valuable insights on the alert page. Before diving into each of these insights, I'd like to highlight some key points to check within the alerts section of the Microsoft 365 Defender portal.

> [!Note]  
> **General data** : SHA256, SHA1, MD5, Signer, File Prevalence, Detection <br>
> **Malware type** : Microsoft Malware family, VirusTotal <br>
> **PE file analysis** : File Content  <New> <br>
> **PE file behavior** : Deep analysis


![image](https://github.com/LearningKijo/SecurityResearcher-Note/assets/120234772/b15b25fa-4167-434a-adbc-29fb86c9786c)

> High-Level Architecture of PE File Analysis in Microsoft 365 Defender

## General data
Initially, you can identify fundamental details such as Hash, Signer, Path, File Prevalence, and Detection directly on the alerts page. 
These insights are crucial for comprehending the malware investigation's overall mapping. Below is the output derived from an example malware.

| Data   | Details        |
|:-------|:---------------|
|  Hash  | MD5 : 5a54de0db43a7512621f0bf10f1c463a <br> SHA1 : 275e8cb6734e4cadafd6648188ef906e5a096940 <br> SHA256 : eef2be5347236331ecd365bdf33ef868b6518beb7ae94074be56f955d2a951d7 |
|  File Name | TypeA.exe, **Original name : [supr.exe]** |
|  File Type | PE, True | 
|  Signer | ***Unsigned file, This file's signer is unknown*** | 
|  Path  | C:\Users\kijo\Desktop\TypeA.exe |
|  File prevalence | Organization devices 2, Organization cloud apps 0, Worldwide devices 2 | 

![image](https://github.com/LearningKijo/SecurityResearcher-Note/assets/120234772/cc3b5ca7-6080-4ad9-8fd2-a86b3f8ef314)


> [!Important] 
> This is a sample malware - MalwareBazaar Database, [Trojan:MSIL/Mokes.B!MTB](https://bazaar.abuse.ch/sample/eef2be5347236331ecd365bdf33ef868b6518beb7ae94074be56f955d2a951d7/#intel). I recommend testing it within ***a sandbox environment***. 

### Malware detection engines ? 
Microsoft Defender Antivirus employs multiple detection engines on both the client and cloud sides to identify advanced malware. 
 On the alert page, you can determine which engine detected the specific malware. For more detailed insights, this [blog](https://www.microsoft.com/en-us/security/blog/2019/06/24/inside-out-get-to-know-the-advanced-technologies-at-the-core-of-microsoft-defender-atp-next-generation-protection/) provides an understanding of each detection engine's capabilities.
 
![image](https://github.com/LearningKijo/SecurityResearcher-Note/assets/120234772/1f2e89a4-f4bd-4cd5-81de-e1dfae8b97d3)


## Malware type
When investigating alerts, you'll not only find malware information, but also malware characteristics, including the type of malware and how it's detected by other 3rd-party antivirus tools. Here, Figure 1 provides an example of malware detection within the alert page of Microsoft 365 Defender.

![image](https://github.com/LearningKijo/SecurityResearcher-Note/assets/120234772/758b0fc1-7d82-417a-9535-aab8e979d4bb)

> Figure 1, Alert page in Microsoft 365 Defender

From the malware detection [(malware family)](https://learn.microsoft.com/en-us/microsoft-365/security/intelligence/malware-naming?view=o365-worldwide) on the alert page, we can discern that this specific malware, Mokes, has been categorized as a Trojan and is coded using Microsoft Intermediate Language (MSIL) such as C#, VB,.NET, and so on. The "Variant" label (.B) suggests that this is not the initial version of the attack. Additionally, there's a possibility that this malware might be capable of encrypting data.

| Malware name | Details            |
|:--------------|:-------------------|
| Trojan:MSIL/Mokes.B!MTB | Type : Trojan <br> Platform : MSIL, .NET intermediate language scripts <br> Family : Mokes <br> Variant : .B <br> !Suffixes : !MTB, the encrypted data |



This malware has been detected by 56 different 3rd-party antivirus tools and is consistently categorized as a Trojan on [VirusTotal](https://www.virustotal.com/gui/home/upload). Additionally, specific characteristics have been highlighted, such as "downloader" and "dropper." This indicates that the malware can access an IP address or URL and potentially download files for further malicious activity.

![image](https://github.com/LearningKijo/SecurityResearcher-Note/assets/120234772/08a17126-e4ff-4de9-8f5b-67a02b16ccbe)

## Malware behaviors
Through [deep analysis](https://learn.microsoft.com/en-us/microsoft-365/security/defender-endpoint/respond-file-alerts?view=o365-worldwide#deep-analysis) in Microsoft Defender for Endpoint, you can access deeper insights into the malware's behavior. 
Normally, to achieve this, known as basic dynamic malware analysis, you would have to install certain tools such as Process Hacker, Process Monitor, Wireshark and so on. 
However, this feature investigates activities within a cloud-based sandbox environment in Microsoft Defender for Endpoint, enabling security analysts to observe the malware's behavior without actual execution in their sandbox environment.

Here is a summary of ***[Behaviors]***, categorized with each section along with a brief explanation.

| Behaviors |   Details    |
|:----------|:-------------|
| Communication | Clusters network communication related behaviors. |
| Environment Awareness | Clusters environment awareness related behaviors, such as querying for host information. such behaviors can be associated with sandbox detection. | 
| Installation and persistency | Clusters installation and persistency related behaviors, such as dropping files to interesting places, setting files to be loaded when Windows starts, etc. |
| Interaction With System Processes | Clusters interaction with system processes behaviors, such as memory injection to svchost.exe |
| Miscellaneous | Clusters miscellaneous behaviors which are not directly related to any other capability. | 
| Security Degradation | Clusters security degradation related behaviors, such as disablement of security features. |

In the ***[Observables]*** section, files and IPs have been observed during the execution of the malware through deep analysis. Since no hash value is provided, evaluating it in VirusTotal might be a bit challenging. However, these dropped files will be immensely useful for further analysis because they allow us to ascertain the types of files that are created or downloaded. Concerning IPs, some of them appear suspicious, and even VirusTotal has flagged them as malicious.

![image](https://github.com/LearningKijo/SecurityResearcher-Note/assets/120234772/872b2049-48a2-4a4a-a1ca-2b138e5aa6fe)

Thanks to [the recent update](https://techcommunity.microsoft.com/t5/microsoft-365-defender-blog/new-file-analysis-and-pivoting-capabilities-in-microsoft-365/ba-p/3853313), Microsoft 365 Defender now provides additional PE insights, including Strings, Imports, Exports, MITRE ATT&CK, and more. In this context, I can examine numerous string values, which are highly valuable for understanding how this malware was constructed.

By examining the strings in [file content](https://learn.microsoft.com/en-us/microsoft-365/security/defender-endpoint/investigate-files?view=o365-worldwide), it becomes evident that the malware predominantly utilized mscoree.dll along with their related API calls. Furthermore, the original file name [super.exe] is discernible. Since strings might be obfuscated, the assistance of third-party tools for decoding the strings may be necessary.

![image](https://github.com/LearningKijo/SecurityResearcher-Note/assets/120234772/f9c891e7-bf82-4dc3-933d-fa18f0d6885d)

In the realm of malware analysis, we can certainly utilize third-party tools to gain deeper insights into PE files. In the upcoming XDR blog, 
I plan to delve into further malware analysis of Type A, specifically focusing on  ***deep analysis insights*** and ***PE file data using third-party tools*** such as PE Studio.

#### Disclaimer
The views and opinions expressed herein are those of the author and do not necessarily reflect the views of company.
