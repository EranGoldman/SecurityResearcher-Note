# Day 11 - XDR insights - File Analysis <1/2>
In the previous blog, we explored fundamental malware analysis using Microsoft 365 Defender. Thanks to Microsoft 365 Defender, we obtained essential insights into the malware file and accurately identified its type. Ultimately, we revealed the malware's dropped files and IPs by leveraging deep analysis.

Now, I'm excited to cover a much deeper exploration of deep analysis and PE analysis, leveraging the capabilities of third-party tools.

> [!Note]
> If you missed the chance to read Malware Analysis Part 1, here is [Day11-MalwareAnalysis-Insights-part1.md](https://github.com/LearningKijo/SecurityResearcher-Note/blob/main/SecurityResearcher-Note-Folder/Day11-MalwareAnalysis-Insights-part1.md).

## Deep anaysis in MDE
After [deep analysis](https://learn.microsoft.com/en-us/microsoft-365/security/defender-endpoint/respond-file-alerts?view=o365-worldwide#deep-analysis) unpacked the PE file in a cloud-based sandbox environment in MDE and provided a comprehensive report, I highlighted suspicious activities from the results. 
Concerning Command and Control (C2C) , we can observe that the Type A malware [supr.exe] attempts to access an external IP [40.9.74.80] via an HTTP request. 
While [13.107.4.50] appears to be a legitimate access point, it was flagged in VirusTotal. This suggests that the IP might be used as a legitimate remote access tool.

![image](https://github.com/LearningKijo/SecurityResearcher-Note/assets/120234772/ea8eb0ac-ac05-4e9a-901d-464e6c78e830)

In terms of persistence, Type A [supr.exe] can create [oneet.exe] and set up a scheduled task to run [oneet.exe] every 1 minute. 
Additionally, [oneet.exe] initiates [cmd.exe] to control access to specific files and directories.

![image](https://github.com/LearningKijo/SecurityResearcher-Note/assets/120234772/8ecbdf02-7e61-48a2-b939-d25cffc6ec9b)


## ANY.RUN ?
Any.Run is a tool that helps cybersecurity experts and researchers safely test and study malicious software (malware). 
It lets them see what the malware does without harming real computers. 
They can upload suspicious files or links, and Any.Run shows how the malware behaves in a safe environment, helping experts learn how to protect against it.

Thanks to [Any.Run](https://app.any.run/tasks/7ad0e3c5-1617-437f-8cbb-700e40026cee/) and the Deep Analysis results, we can clearly see and understand how Type A [supr.exe] behaves during runtime. 
While we might have already gathered some insights from the Deep Analysis, Any.Run helps us visualize the logic of malware activities, such as the process tree. 
It allows us to sync each process with the process tree, especially in the case of C2C activities.

![image](https://github.com/LearningKijo/SecurityResearcher-Note/assets/120234772/1cda860c-8263-480a-8fbb-4c1747404d1d)
> ANY.RUN - Type A [supr.exe] process tree

![image](https://github.com/LearningKijo/SecurityResearcher-Note/assets/120234772/8a68527d-346d-42fa-a09b-518b7e9b25aa)
> ANY.RUN - C2C activities

## Pestudio ?
[Pestudio](https://www.winitor.com/download) is a software tool used for analyzing and inspecting executable files (programs). 
It provides information about these files, including details about their structure, imported and exported functions, embedded strings, and resources, among other aspects. In the cybersecurity field, Pestudio is utilized for static analysis, examining PE files without executing them.


Based on PeStudio output, it appears that obfuscation techniques were used in the PE file. 
This includes the presence of a base64 string and the use of some suspicious APIs such as [MemoryStream](https://learn.microsoft.com/en-us/dotnet/api/system.io.memorystream?view=net-7.0) and [CheckRemoteDebuggerPresent](https://learn.microsoft.com/en-us/windows/win32/api/debugapi/nf-debugapi-checkremotedebuggerpresent).

Through Pestudio, I managed to gather insights about the content within the PE file that might not have been fully covered by MDE. 
While I didn't delve into every detail, the static analysis of PE file revealed signs of obfuscation and other interesting elements.

![image](https://github.com/LearningKijo/SecurityResearcher-Note/assets/120234772/3eaac226-4a09-4535-aa69-116d771eafb4)
> Pestudio - Suspicous values from strings

#### Disclaimer
The views and opinions expressed herein are those of the author and do not necessarily reflect the views of company.
