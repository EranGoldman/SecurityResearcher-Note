# MDE + MDI better together - Reconnaissance
Hello, all defenders and threat hunters! Thank you for visiting my product research note. 
As we primarily focused on exploring how Microsoft Defender for Endpoint (MDE) and Microsoft Defender for Identity (MDI) work better together, 
emphasizing [command-based AD reconnaissance in Part 1](https://github.com/LearningKijo/SecurityResearcher-Note/blob/main/ProductResearch-Note-Folder/Day01-MDE-MDI-BetterTogether-Part1.md), this time we are going to shift our focus to AD reconnaissance using some pretesting tools.

## Pretesting tools
Before I begin showcasing MDE + MDI detection, I would like to show a simulation. 
The simulation itself is quite simple, and what you have to do is install pentesting tools and run them on a compromised AD-joined device.

![image](https://github.com/LearningKijo/SecurityResearcher-Note/assets/120234772/b859cdc9-fddd-4b8d-8948-105005dc070b)

> [!Important]
> These tools are used for attack simulation in this blog. Please use them in a testing environment and avoid using them in a production environment.
> 1. ORADAD - https://github.com/ANSSI-FR/ORADAD 
> 2. NetSess - https://www.joeware.net/freetools/tools/netsess/ 
> 3. ADRecon - https://github.com/sense-of-security/ADRecon

## Detection, XDR
After running three tools on the compromised AD-joined device, 1 incident (which is correlated with 9 alerts generated from MDE & MDI) appeared on Incident page on Microsoft Defender XDR portal.
As I primarily used three tools, let's take a look how these tools will be mapped on alert pages in the context of MDE and MDI.

```
Incident : Multi-stage incident involving Credential access & Discovery on one endpoint reported by multiple sources
    Alerts : Detection source, Alert name
        - EDR, Possible Active Directory data enumeration using ADRecon
        - EDR, Suspicious sequence of exploration activities
        - EDR, Suspicious User Account Discovery
        - EDR, Credential theft attempt of Group Managed Service Accounts (gMSA)
        - EDR, Suspicious LDAP query
        - EDR, Active Directory Certificate Services attack tool activity
        - MDI, User and IP address reconnaissance (SMB)
        - MDI, Security principal reconnaissance (LDAP)
        - Defender XDR, Enumeration of SMB sessions on a domain controller
```
> All generated alerts after the simulation in Incident    

![image](https://github.com/LearningKijo/SecurityResearcher-Note/assets/120234772/97dcd6a3-c6cb-447e-be0d-9933234f99c0)
> Incident page : Multi-stage incident involving Credential access & Discovery on one endpoint reported by multiple sources

### ORADAD tool detection in MDE & MDI
At first, this alert was generated by MDI when the MDI sensor detected suspicious activity from Win10BB. 
MDI sensor raised an alert as Win10BB (Compromised device) sent a suspicious LDAP query to the Domain Controller for enumeration. 
It's worth noting that MDI covers a range of enumerated types, such as  ***"AllObjects", "AllComputers", "AllUsers", and "AllGroupPolicies"***.

![image](https://github.com/LearningKijo/SecurityResearcher-Note/assets/120234772/0ff61b3a-9e7a-4de7-9f72-325a6896721c)
> MDI alert, Security principal reconnaissance (LDAP)

In terms of MDE detection, I observed three alerts : 
- [x] Suspicious LDAP Query
- [x] Active Directory Certificate Services Attack Tool Activity
- [x] Credential theft attempt of Group Managed Service Accounts (gMSA)

These alerts shed light on the executed tool on Win10BB by the attacker, even capturing each LDAP query performed by the tool (ORADAD) as follows.

```query
< ----- Suspicious LDAP Query ----- >
LDAP Search query (objectClass=group), Distinguished name CN=Configuration,DC=mdipoc,DC=com
LDAP Search query (|(objectClass=domain)(objectClass=domainDNS)), Distinguished name DC=mdipoc,DC=com
LDAP Search query (&(objectClass=user)(!(|(objectClass=computer)(objectClass=msDS-ManagedServiceAccount)(objectClass=msDS-GroupManagedServiceAccount)))), Distinguished name DC=mdipoc,DC=com

< ----- Active Directory Certificate Services Attack Tool Activity ----- >
LDAP Search query (objectClass=pKICertificateTemplate), Distinguished name CN=Configuration,DC=mdipoc,DC=com

< ----- Credential theft attempt of Group Managed Service Accounts (gMSA) ----- >
LDAP Search query (objectClass=msDS-GroupManagedServiceAccount), Distinguished name DC=mdipoc,DC=com
```

![image](https://github.com/LearningKijo/SecurityResearcher-Note/assets/120234772/e6a9a092-7e12-46fd-956f-f4b9d251dc91)
> MDE alerts, which are highlighting some LDAP query execution

### NetSess tool detection in MDE & MDI
Secondly, NetSess tool activity was captured by MDI and Defender XDR, initially detected by MDE through XDR alert correlation. 
From the SOC team's perspective, this not only enables them to identify instances of "User and IP address reconnaissance" but also provides insights into ***how attackers executed tools, 
the specific commands they used, and the timeline associated with these actions from an Endpoint perspective.***

![image](https://github.com/LearningKijo/SecurityResearcher-Note/assets/120234772/0129fe1d-9600-475e-adb1-bab39dfef2a8)
> Defender XDR, Enumeration of SMB sessions on a domain controller

For instance, MDI alert indicates that Mike Ninja on Win10BB (Compromised device) initiated a session on DC and is attempting to gather recent logon information, such as IP address and user.
However, what we would like to identify is more detailed activity, especially how this activity is performed by the attacker.

![image](https://github.com/LearningKijo/SecurityResearcher-Note/assets/120234772/7fa1df61-9aac-4f63-b802-b782167c7845)
> MDI alert, User and IP address reconnaissance (SMB)

One of the significant advantages of deploying MDE is the ability to capture SMB session activities from the endpoint perspective. 
When reviewing MDE alert detections, we can clearly discern the tools employed by attackers and even the specific command lines they used. 
Additionally, MDE captures hash values and offers file detection insights from VirusTotal.

![image](https://github.com/LearningKijo/SecurityResearcher-Note/assets/120234772/efd4956c-db6d-412d-b1a3-622673111cdc)
> Defender XDR, Enumeration of SMB sessions on a domain controller

### ADRecon tool detection in MDE 
Lastly, the attacker conducted ADRecon, triggering alerts in MDE. 
Notably, MDE promptly captured the suspicious activities, identifying them as the ADRecon tool. 
Furthermore, MDE provided a comprehensive list of all files created during the ADRecon enumeration in the alert.

![image](https://github.com/LearningKijo/SecurityResearcher-Note/assets/120234772/f49ecfcc-e36d-4547-b267-8b98dc37aa0d)
> MDE alert, Possible Active Directory data enumeration using ADRecon

Another alert from MDE indicates the execution of PowerShell commandlets (performed by the ADRecon tool) on the endpoint.

![image](https://github.com/LearningKijo/SecurityResearcher-Note/assets/120234772/31317e90-158e-44f2-94e9-a282e7689c5c)
> MDE alert, Suspicious sequence of exploration activities

In 'MDE + MDI: Better Together Part 1 & Part 2', I explored reconnaissance detection, emphasizing the robust detection capabilities when both products are used in tandem. 
I plan to delve into additional insights such as hunting, response, and other attack phases in the future. Thank you for reading !!

#### Disclaimer
The views and opinions expressed herein are those of the author and do not necessarily reflect the views of company.
